<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–µ—Å—Ç–µ—Ä–∏—è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* –°—Ç–∏–ª–∏ –∏–≥—Ä—ã */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            overflow: hidden; 
            user-select: none;
            margin: 0;
            padding: 0;
        }

        /* –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ */
        #loading-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            transition: opacity 0.5s;
        }
        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #fbbf24;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        #game-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: relative; 
        }

        /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        #left-panel {
            width: 250px;
            background-color: #2d3748;
            border-right: 1px solid #4a5568;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            flex-shrink: 0;
            z-index: 10;
        }
        #game-title {
            font-family: 'Caveat', cursive;
            font-size: 2.5rem;
            color: #fbbf24;
            text-align: center;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .menu-button {
            background-color: #4a5568;
            color: white;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: 0.2s;
        }
        .menu-button:hover { background-color: #718096; color: #fbbf24; }
        .menu-button i { margin-right: 0.75rem; width: 20px; text-align: center; }

        /* –¶–µ–Ω—Ç—Ä */
        #main-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            position: relative;
        }
        #story-log {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding-right: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        .log-entry {
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #2d3748;
            border-left: 4px solid #4a5568;
            line-height: 1.6;
            animation: fadeIn 0.3s ease-out;
        }
        .log-entry.system { border-left-color: #ef4444; color: #fca5a5; font-style: italic; }
        .log-entry.player { border-left-color: #fbbf24; background-color: #374151; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* –í–≤–æ–¥ */
        #input-area { display: flex; gap: 0.5rem; }
        #action-input {
            flex-grow: 1; padding: 1rem; border-radius: 0.5rem;
            background-color: #2d3748; border: 1px solid #4a5568; color: white;
        }
        #send-button {
            padding: 0 1.5rem; background-color: #fbbf24; color: #1a202c;
            border-radius: 0.5rem; font-weight: bold; cursor: pointer;
        }
        #send-button:disabled { background-color: #718096; cursor: not-allowed; }

        /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å */
        #right-panel {
            width: 300px;
            background-color: #2d3748;
            border-left: 1px solid #4a5568;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }
        .stat-row { display: flex; justify-content: space-between; font-size: 0.9rem; }
        .progress-bar-container { background: #1a202c; height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; transition: width 0.5s; }
        .bg-health { background-color: #ef4444; }
        .bg-mana { background-color: #3b82f6; }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–π –∞–¥–∞–ø—Ç–∏–≤ */
        @media (max-width: 768px) {
            #game-container { flex-direction: column; }
            #left-panel, #right-panel { display: none; } /* –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –ø–æ–∫–∞ —Å–∫—Ä–æ–µ–º –Ω–∞ –º–æ–± */
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loader-spinner"></div>
        <div id="loading-text">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏...</div>
        <div id="error-message" style="color: #ef4444; margin-top: 10px; text-align: center; max-width: 80%; display: none;"></div>
    </div>

    <div id="game-container">
        <div id="left-panel">
            <div id="game-title">–í–µ—Å—Ç–µ—Ä–∏—è</div>
            <div class="menu-button"><i class="fas fa-user"></i>–ü–µ—Ä—Å–æ–Ω–∞–∂</div>
            <div class="menu-button"><i class="fas fa-book"></i>–ó–∞–¥–∞–Ω–∏—è</div>
            <div class="menu-button"><i class="fas fa-cog"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        </div>

        <div id="main-area">
            <div id="story-log"></div>
            <div id="input-area">
                <input type="text" id="action-input" placeholder="–í–∞—à–µ –¥–µ–π—Å—Ç–≤–∏–µ..." autocomplete="off">
                <button id="send-button"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="right-panel">
            <h3 style="color:#fbbf24; font-family:'Caveat'; font-size:1.5rem; border-bottom:1px solid #4a5568;">–°–æ—Å—Ç–æ—è–Ω–∏–µ</h3>
            
            <div class="stat-row"><span>–ó–¥–æ—Ä–æ–≤—å–µ</span><span id="hp-val">100/100</span></div>
            <div class="progress-bar-container"><div class="progress-bar bg-health" id="hp-bar" style="width: 100%"></div></div>
            
            <div class="stat-row"><span>–ú–∞–Ω–∞</span><span id="mp-val">50/50</span></div>
            <div class="progress-bar-container"><div class="progress-bar bg-mana" id="mp-bar" style="width: 100%"></div></div>

            <h3 style="color:#fbbf24; font-family:'Caveat'; font-size:1.5rem; border-bottom:1px solid #4a5568; margin-top:1rem;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
            <div id="inventory-list" style="font-size: 0.9rem; color: #a0aec0;">–ü—É—Å—Ç–æ</div>
        </div>
    </div>

<script>
    // --- –ù–ê–°–¢–†–û–ô–ö–ò –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
    const apiUrl = '/api/chat'; // –ü—É—Ç—å –∫ —Å–µ—Ä–≤–µ—Ä—É Vercel
    let gameState = {
        hp: 100, maxHp: 100,
        mp: 50, maxMp: 50,
        inventory: [],
        location: "–°—Ç–∞—Ä—ã–π –ª–∞–≥–µ—Ä—å",
        history: [] // –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    };

    // –≠–ª–µ–º–µ–Ω—Ç—ã UI
    const ui = {
        log: document.getElementById('story-log'),
        input: document.getElementById('action-input'),
        btn: document.getElementById('send-button'),
        loading: document.getElementById('loading-screen'),
        loadingText: document.getElementById('loading-text'),
        errorMsg: document.getElementById('error-message'),
        hpVal: document.getElementById('hp-val'),
        hpBar: document.getElementById('hp-bar')
    };

    // --- –§–£–ù–ö–¶–ò–ò ---

    function addLog(text, type = 'normal') {
        const div = document.createElement('div');
        div.className = `log-entry ${type}`;
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º markdown-–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç (**—Ç–µ–∫—Å—Ç**) –≤ html (<b>—Ç–µ–∫—Å—Ç</b>)
        let formatted = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        div.innerHTML = formatted;
        ui.log.appendChild(div);
        ui.log.scrollTop = ui.log.scrollHeight;
    }

    function updateStats(updates) {
        if (!updates) return;
        if (updates.hp) gameState.hp = Math.max(0, Math.min(gameState.maxHp, gameState.hp + updates.hp));
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        ui.hpVal.innerText = `${gameState.hp}/${gameState.maxHp}`;
        ui.hpBar.style.width = `${(gameState.hp / gameState.maxHp) * 100}%`;
    }

    // –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–ê–ü–†–û–° –ö –ù–ï–ô–†–û–°–ï–¢–ò
    async function sendAction(action) {
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤–≤–æ–¥
        ui.input.disabled = true;
        ui.btn.disabled = true;
        ui.loading.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä (–º–∞–ª–µ–Ω—å–∫–∏–π –∏–ª–∏ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å)
        ui.loading.style.backgroundColor = 'rgba(0,0,0,0.3)'; // –õ–µ–≥–∫–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Ö–æ–¥–µ
        ui.loadingText.innerText = "–ú–∞—Å—Ç–µ—Ä –æ–±–¥—É–º—ã–≤–∞–µ—Ç —Ö–æ–¥...";
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        const messages = [
            {
                role: "system",
                content: `–¢—ã ‚Äî –ì–µ–π–º –ú–∞—Å—Ç–µ—Ä —Ç–µ–∫—Å—Ç–æ–≤–æ–π RPG "–í–µ—Å—Ç–µ—Ä–∏—è". 
                –ü—Ä–∞–≤–∏–ª–∞:
                1. –û—Ç–≤–µ—á–∞–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.
                2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞: { "narrative": "–¢–µ–∫—Å—Ç —Å—é–∂–µ—Ç–∞", "hp_change": 0 }.
                3. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π markdown –≤ JSON.
                4. –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä–æ–∫–∞: HP ${gameState.hp}.`
            },
            ...gameState.history,
            { role: "user", content: action }
        ];

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages: messages })
            });

            if (!response.ok) {
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä Invalid Key), —á–∏—Ç–∞–µ–º –µ—ë —Ç–µ–∫—Å—Ç
                const errText = await response.text();
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status}): ${errText}`);
            }

            const data = await response.json();
            
            // Gemini –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–∂–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –Ω–∞–º –Ω—É–∂–Ω–æ –¥–æ—Å—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç
            // –û–±—ã—á–Ω–æ —ç—Ç–æ data.candidates[0].content.parts[0].text
            let rawText = "";
            if (data.candidates && data.candidates[0].content) {
                rawText = data.candidates[0].content.parts[0].text;
            } else if (data.text) {
                rawText = data.text; // –î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–æ–∫—Å–∏
            } else {
                throw new Error("–ù–µ–ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏");
            }

            // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏
            // –ß–∞—Å—Ç–æ –Ω–µ–π—Ä–æ—Å–µ—Ç—å –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç JSON –≤ ```json ... ```, –Ω–∞–¥–æ –ø–æ—á–∏—Å—Ç–∏—Ç—å
            const jsonString = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
            const gameData = JSON.parse(jsonString);

            // 1. –í—ã–≤–æ–¥–∏–º —Å—é–∂–µ—Ç
            addLog(gameData.narrative);
            
            // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—ã
            if (gameData.hp_change) updateStats({ hp: gameData.hp_change });

            // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            gameState.history.push({ role: "user", content: action });
            gameState.history.push({ role: "model", content: jsonString });

        } catch (e) {
            console.error(e);
            addLog(`‚ùå <b>–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞:</b> ${e.message}`, "system");
            if (e.message.includes("API key")) {
                addLog("üëâ –ü—Ä–æ–≤–µ—Ä—å –∫–ª—é—á API –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Vercel!", "system");
            }
        } finally {
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤–≤–æ–¥
            ui.input.disabled = false;
            ui.btn.disabled = false;
            ui.input.value = '';
            ui.input.focus();
            ui.loading.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    window.addEventListener('load', () => {
        // –°–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É
        ui.loading.style.display = 'none';
        
        // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        addLog("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –í–µ—Å—Ç–µ—Ä–∏—é. –í—ã —Å—Ç–æ–∏—Ç–µ —É –ø–æ—Ç—É—Ö—à–µ–≥–æ –∫–æ—Å—Ç—Ä–∞. –í–æ–∫—Ä—É–≥ —Ç–µ–º–Ω—ã–π –ª–µ—Å.", "system");
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        ui.btn.addEventListener('click', () => {
            const val = ui.input.value.trim();
            if (val) {
                addLog(val, "player");
                sendAction(val);
            }
        });
        
        ui.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') ui.btn.click();
        });
    });

</script>
</body>
</html>
