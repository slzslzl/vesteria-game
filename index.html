<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–µ—Å—Ç–µ—Ä–∏—è: –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { background-color: #1a202c; color: #e2e8f0; margin: 0; display: flex; height: 100vh; flex-direction: column; overflow: hidden; }
        
        /* –õ–æ–≥ —Å–æ–æ–±—â–µ–Ω–∏–π */
        #story-log { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .entry { padding: 15px; border-radius: 8px; background: #2d3748; border-left: 4px solid #4a5568; line-height: 1.5; }
        .entry.player { border-left-color: #fbbf24; background: #374151; align-self: flex-end; max-width: 80%; }
        .entry.system { border-left-color: #ef4444; color: #fca5a5; font-style: italic; }

        /* –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ - –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û –í–ò–î–ò–ú–ê–Ø */
        #input-container { 
            background: #2d3748; 
            padding: 20px; 
            border-top: 2px solid #4a5568;
            display: flex;
            gap: 10px;
            z-index: 9999; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
        }
        
        input { 
            flex: 1; 
            background: #1a202c; 
            border: 1px solid #4a5568; 
            padding: 12px; 
            color: white; 
            border-radius: 5px;
            outline: none;
        }
        input:focus { border-color: #fbbf24; }
        
        button { 
            background: #fbbf24; 
            color: #1a202c; 
            font-weight: bold; 
            padding: 0 25px; 
            border-radius: 5px; 
            cursor: pointer;
        }
        button:disabled { background: #4a5568; opacity: 0.5; }

        /* –°–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .typing { font-size: 0.8rem; color: #fbbf24; margin-bottom: 5px; display: none; }
    </style>
</head>
<body>

    <div id="story-log">
        <div class="entry"><b>–°–∏—Å—Ç–µ–º–∞:</b> –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∏—Ä–∞...</div>
    </div>

    <div id="input-container">
        <div id="status-typing" class="typing" style="position: absolute; top: -25px; left: 20px;">–ú–∞—Å—Ç–µ—Ä –¥—É–º–∞–µ—Ç...</div>
        <input type="text" id="user-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –¥–µ–π—Å—Ç–≤–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –æ—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è)..." autocomplete="off">
        <button id="send-btn">–û–¢–ü–†–ê–í–ò–¢–¨</button>
    </div>

    <script>
        const log = document.getElementById('story-log');
        const input = document.getElementById('user-input');
        const btn = document.getElementById('send-btn');
        const typing = document.getElementById('status-typing');

        function addEntry(text, type = '') {
            const div = document.createElement('div');
            div.className = `entry ${type}`;
            div.innerHTML = text.replace(/\n/g, '<br>');
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        async function play(action) {
            if (!action) return;
            
            addEntry(action, 'player');
            input.value = '';
            input.disabled = true;
            btn.disabled = true;
            typing.style.display = 'block';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{ role: "user", content: action }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                }

                const data = await response.json();
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Gemini
                let aiText = "";
                if (data.candidates && data.candidates[0].content) {
                    aiText = data.candidates[0].content.parts[0].text;
                } else {
                    aiText = "–ù–µ–π—Ä–æ—Å–µ—Ç—å –ø—Ä–∏—Å–ª–∞–ª–∞ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API.";
                }

                addEntry(aiText);

            } catch (e) {
                addEntry(`‚ùå –û–®–ò–ë–ö–ê: ${e.message}`, 'system');
                console.error(e);
            } finally {
                input.disabled = false;
                btn.disabled = false;
                typing.style.display = 'none';
                input.focus();
            }
        }

        btn.onclick = () => play(input.value);
        input.onkeypress = (e) => { if (e.key === 'Enter') play(input.value); };

        // –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = async () => {
            addEntry("‚öôÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ —Å Gemini API...", "system");
            try {
                const res = await fetch('/api/chat', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ messages: [{role:"user", content:"–ü—Ä–∏–≤–µ—Ç"}] })
                });
                if (res.ok) {
                    addEntry("‚úÖ –°–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞! –ö–ª—é—á —Ä–∞–±–æ—Ç–∞–µ—Ç. –ú–æ–∂–µ—Ç–µ –Ω–∞—á–∏–Ω–∞—Ç—å –∏–≥—Ä—É.", "system");
                } else {
                    addEntry("‚ö†Ô∏è –û—à–∏–±–∫–∞ –∫–ª—é—á–∞ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Vercel.", "system");
                }
            } catch (e) {
                addEntry("üö´ –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –í—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏ —Å–∞–π—Ç —á–µ—Ä–µ–∑ Vercel?", "system");
            }
        };
    </script>
</body>
</html>
